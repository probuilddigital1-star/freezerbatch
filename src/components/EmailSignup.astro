---
/**
 * Email Signup CTA Component
 *
 * Collects email addresses and sends them to an n8n webhook.
 */

export interface Props {
  /** Headline text */
  headline?: string;
  /** Subheadline text */
  subheadline?: string;
  /** Button text */
  buttonText?: string;
  /** Variant: 'default' | 'dark' | 'gradient' */
  variant?: 'default' | 'dark' | 'gradient';
}

const {
  headline = "Get New Recipes & Tips",
  subheadline = "Join fellow cocktail enthusiasts. We'll send you new batch recipes, pro tips, and the occasional spirit recommendation.",
  buttonText = "Subscribe",
  variant = 'gradient'
} = Astro.props;

// n8n webhook URL for email signups
const webhookUrl = "https://zax76.app.n8n.cloud/webhook/freezerbatch-email";
---

<email-signup-form class="block" data-webhook={webhookUrl}>
  <div class:list={[
    "rounded-2xl p-6 sm:p-10",
    {
      "bg-cream border-2 border-cognac-200": variant === 'default',
      "bg-primary-700 text-white": variant === 'dark',
      "bg-white/10 backdrop-blur-sm border border-white/20 text-white": variant === 'gradient'
    }
  ]}>
    <div class="max-w-xl mx-auto text-center">
      <!-- Icon -->
      <div class:list={[
        "w-12 h-12 sm:w-14 sm:h-14 rounded-2xl flex items-center justify-center mx-auto mb-4 sm:mb-6",
        {
          "bg-accent-100": variant === 'default',
          "bg-accent-500/20": variant === 'dark' || variant === 'gradient'
        }
      ]}>
        <svg class:list={[
          "w-6 h-6 sm:w-7 sm:h-7",
          {
            "text-accent-600": variant === 'default',
            "text-accent-300": variant === 'dark' || variant === 'gradient'
          }
        ]} fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
        </svg>
      </div>

      <!-- Headlines -->
      <h3 class:list={[
        "text-xl sm:text-3xl font-display font-bold mb-2 sm:mb-3",
        {
          "text-primary-600": variant === 'default',
          "text-white": variant === 'dark' || variant === 'gradient'
        }
      ]}>
        {headline}
      </h3>
      <p class:list={[
        "mb-6 sm:mb-8 text-sm sm:text-base",
        {
          "text-cognac": variant === 'default',
          "text-white/70": variant === 'dark',
          "text-white/80": variant === 'gradient'
        }
      ]}>
        {subheadline}
      </p>

      <!-- Form -->
      <form id="signup-form" class="flex flex-col sm:flex-row gap-3 max-w-md mx-auto">
        <div class="flex-1 relative">
          <input
            type="email"
            id="email-input"
            name="email"
            placeholder="your@email.com"
            required
            class:list={[
              "w-full px-4 py-3 sm:py-3.5 rounded-xl text-sm sm:text-base transition-all duration-200",
              "focus:outline-none focus:ring-4",
              {
                "bg-white border-2 border-cognac-200 text-primary-600 placeholder:text-cognac-300 focus:border-accent-500 focus:ring-accent-500/10": variant === 'default',
                "bg-white/10 border-2 border-white/20 text-white placeholder:text-white/50 focus:border-accent-300 focus:ring-accent-300/10": variant === 'dark',
                "bg-white/20 border-2 border-white/30 text-white placeholder:text-white/60 focus:border-accent-300 focus:ring-accent-300/20": variant === 'gradient'
              }
            ]}
          />
        </div>
        <button
          type="submit"
          id="submit-btn"
          class:list={[
            "px-5 sm:px-6 py-3 sm:py-3.5 rounded-xl font-semibold transition-all duration-200",
            "flex items-center justify-center gap-2 w-full sm:w-auto sm:min-w-[140px]",
            "disabled:opacity-50 disabled:cursor-not-allowed",
            {
              "bg-accent-500 text-white hover:bg-accent-400 shadow-lg shadow-accent-500/25 hover:shadow-xl hover:shadow-accent-500/30": variant === 'default',
              "bg-accent-500 text-white hover:bg-accent-400": variant === 'dark',
              "bg-accent-500 text-white hover:bg-accent-400 shadow-lg shadow-black/10": variant === 'gradient'
            }
          ]}
        >
          <span id="btn-text">{buttonText}</span>
          <svg id="btn-arrow" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
          </svg>
          <!-- Loading spinner (hidden by default) -->
          <svg id="btn-spinner" class="w-5 h-5 animate-spin hidden" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
        </button>
      </form>

      <!-- Success Message (hidden by default) -->
      <div id="success-message" class="hidden mt-6">
        <div class:list={[
          "inline-flex items-center gap-2 px-4 py-2 rounded-full",
          {
            "bg-success/10 text-success": variant === 'default',
            "bg-success/20 text-success-400": variant === 'dark',
            "bg-white/20 text-white": variant === 'gradient'
          }
        ]}>
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
          </svg>
          <span class="font-medium">You're in! Check your inbox.</span>
        </div>
      </div>

      <!-- Error Message (hidden by default) -->
      <div id="error-message" class="hidden mt-6">
        <div class:list={[
          "inline-flex items-center gap-2 px-4 py-2 rounded-full",
          {
            "bg-danger/10 text-danger": variant === 'default',
            "bg-danger/20 text-danger-400": variant === 'dark',
            "bg-white/20 text-white": variant === 'gradient'
          }
        ]}>
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <span id="error-text" class="font-medium">Something went wrong. Please try again.</span>
        </div>
      </div>

      <!-- Privacy note -->
      <p class:list={[
        "mt-4 sm:mt-6 text-xs",
        {
          "text-cognac-400": variant === 'default',
          "text-white/50": variant === 'dark' || variant === 'gradient'
        }
      ]}>
        No spam, ever. Unsubscribe anytime.
        <a href="/privacy" class:list={[
          "underline hover:no-underline",
          {
            "text-cognac hover:text-primary-600": variant === 'default',
            "text-white/60 hover:text-white": variant === 'dark' || variant === 'gradient'
          }
        ]}>Privacy Policy</a>
      </p>
    </div>
  </div>
</email-signup-form>

<script>
  class EmailSignupForm extends HTMLElement {
    private form: HTMLFormElement | null;
    private emailInput: HTMLInputElement | null;
    private submitBtn: HTMLButtonElement | null;
    private btnText: HTMLElement | null;
    private btnArrow: HTMLElement | null;
    private btnSpinner: HTMLElement | null;
    private successMessage: HTMLElement | null;
    private errorMessage: HTMLElement | null;
    private errorText: HTMLElement | null;
    private webhookUrl: string;

    constructor() {
      super();
      this.form = null;
      this.emailInput = null;
      this.submitBtn = null;
      this.btnText = null;
      this.btnArrow = null;
      this.btnSpinner = null;
      this.successMessage = null;
      this.errorMessage = null;
      this.errorText = null;
      this.webhookUrl = '';
    }

    connectedCallback() {
      this.form = this.querySelector('#signup-form');
      this.emailInput = this.querySelector('#email-input');
      this.submitBtn = this.querySelector('#submit-btn');
      this.btnText = this.querySelector('#btn-text');
      this.btnArrow = this.querySelector('#btn-arrow');
      this.btnSpinner = this.querySelector('#btn-spinner');
      this.successMessage = this.querySelector('#success-message');
      this.errorMessage = this.querySelector('#error-message');
      this.errorText = this.querySelector('#error-text');
      this.webhookUrl = this.dataset.webhook || '';

      this.form?.addEventListener('submit', (e) => this.handleSubmit(e));
    }

    private async handleSubmit(e: Event) {
      e.preventDefault();

      if (!this.emailInput || !this.submitBtn) return;

      const email = this.emailInput.value.trim();
      if (!email) return;

      // Set loading state
      this.setLoading(true);
      this.hideMessages();

      try {
        const response = await fetch(this.webhookUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            email,
            source: 'freezerbatchcocktails.com',
            timestamp: new Date().toISOString(),
            page: window.location.pathname
          }),
        });

        if (!response.ok) {
          throw new Error('Signup failed');
        }

        // Success
        this.showSuccess();
        this.emailInput.value = '';

      } catch (error) {
        console.error('Email signup error:', error);
        this.showError('Something went wrong. Please try again.');
      } finally {
        this.setLoading(false);
      }
    }

    private setLoading(loading: boolean) {
      if (!this.submitBtn || !this.btnText || !this.btnArrow || !this.btnSpinner) return;

      this.submitBtn.disabled = loading;

      if (loading) {
        this.btnText.textContent = 'Sending...';
        this.btnArrow.classList.add('hidden');
        this.btnSpinner.classList.remove('hidden');
      } else {
        this.btnText.textContent = 'Subscribe';
        this.btnArrow.classList.remove('hidden');
        this.btnSpinner.classList.add('hidden');
      }
    }

    private hideMessages() {
      this.successMessage?.classList.add('hidden');
      this.errorMessage?.classList.add('hidden');
    }

    private showSuccess() {
      this.form?.classList.add('hidden');
      this.successMessage?.classList.remove('hidden');
    }

    private showError(message: string) {
      if (this.errorText) {
        this.errorText.textContent = message;
      }
      this.errorMessage?.classList.remove('hidden');
    }
  }

  customElements.define('email-signup-form', EmailSignupForm);
</script>
